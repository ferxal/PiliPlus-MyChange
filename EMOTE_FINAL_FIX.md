# è¡¨æƒ…åŒ…åŠ å¯†é—®é¢˜æœ€ç»ˆä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜è¯Šæ–­

### ç”¨æˆ·å‘ç°çš„å…³é”®çº¿ç´¢
- åœ¨PiliPluså®¢æˆ·ç«¯å‘é€ `[honkai3_pure_3]` â†’ æ˜¾ç¤ºä¸º `Q^edaW_)Ufkh[U)S` (ä¹±ç )
- åœ¨å®˜æ–¹å¹³å°æŸ¥çœ‹åŒä¸€æ¶ˆæ¯ â†’ æ˜¾ç¤ºä¸º `[honkai3_pure_3]` (æ­£å¸¸)

### æ ¹æœ¬åŸå› 
**è¡¨æƒ…ç¬¦æ²¡æœ‰è¢«åŠ å¯†ï¼Œä½†è¢«è¯¯åˆ¤ä¸ºåŠ å¯†æ¶ˆæ¯å¹¶è¢«è§£å¯†äº†ï¼**

```
å‘é€æµç¨‹ï¼ˆä¹‹å‰çš„é”™è¯¯ï¼‰ï¼š
[honkai3_pure_3] â†’ æ·»åŠ æ ‡è®° â†’ ï¿¿[honkai3_pure_3]

æ¥æ”¶æµç¨‹ï¼ˆPiliPlusï¼‰ï¼š
ï¿¿[honkai3_pure_3] â†’ çœ‹åˆ°ï¿¿æ ‡è®° â†’ è®¤ä¸ºæ˜¯åŠ å¯†æ¶ˆæ¯ 
â†’ å¯¹æ•´ä¸ªå†…å®¹è§£å¯†ï¼ˆå­—ç¬¦-10ï¼‰â†’ Q^edaW_)Ufkh[U)S âŒ

æ¥æ”¶æµç¨‹ï¼ˆå®˜æ–¹å¹³å°ï¼‰ï¼š
ï¿¿[honkai3_pure_3] â†’ æ²¡æœ‰è§£å¯†é€»è¾‘ â†’ ç›´æ¥æ˜¾ç¤º [honkai3_pure_3] âœ…
```

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒåŸåˆ™
**[meme]æ ¼å¼çš„å†…å®¹åœ¨å‘é€å’Œæ¥æ”¶æ—¶éƒ½ä¸è¿›è¡Œä»»ä½•åŠ å¯†/è§£å¯†å¤„ç†**

### ä¿®æ”¹1: å‘é€é€»è¾‘ (`lib/pages/whisper_detail/controller.dart`)

```dart
String _processSendContent(String content) {
  final buffer = StringBuffer();
  content.splitMapJoin(
    RegExp(r'\[.*?\]'),  // åŒ¹é…æ‰€æœ‰[...]æ ¼å¼
    onMatch: (match) {
      buffer.write(match.group(0));  // âœ… è¡¨æƒ…ç¬¦ä¿æŒåŸæ ·ï¼Œä¸åŠ å¯†
      return '';
    },
    onNonMatch: (nonMatch) {
      if (nonMatch.isNotEmpty) {
        // ğŸ”’ åªåŠ å¯†æ™®é€šæ–‡æœ¬
        final encrypted = nonMatch.runes.map((rune) {
          int newRune = rune + 10;
          if (newRune > 0x10FFFF) newRune -= 0x110000;
          return String.fromCharCode(newRune);
        }).join();
        buffer.write(encrypted);
      }
      return '';
    },
  );
  return '\uFFFF' + buffer.toString();  // æ·»åŠ åŠ å¯†æ ‡è®°
}
```

### ä¿®æ”¹2: æ¥æ”¶é€»è¾‘ (`lib/pages/whisper_detail/widget/chat_item.dart`)

#### æ·»åŠ è¡¨æƒ…ç¬¦ä¿æŠ¤
```dart
final List<String> patterns = [
  Constants.urlRegex.pattern,
  r'\[[\w_]+\]',  // â­ æ·»åŠ è‡ªå®šä¹‰è¡¨æƒ…åŒ…æ ¼å¼ä¿æŠ¤
];
```

#### è§£å¯†æ—¶è·³è¿‡è¡¨æƒ…ç¬¦
```dart
String _processReceiveContent(String content) {
  if (!content.startsWith('\uFFFF')) {
    return content;  // æ²¡æœ‰åŠ å¯†æ ‡è®°ï¼Œç›´æ¥è¿”å›
  }
  content = content.substring(1);  // ç§»é™¤ï¿¿æ ‡è®°
  
  final regex = RegExp(patterns.join('|'));
  final buffer = StringBuffer();
  content.splitMapJoin(
    regex,
    onMatch: (match) {
      buffer.write(match.group(0));  // âœ… URLå’Œè¡¨æƒ…ç¬¦ä¸è§£å¯†
      return '';
    },
    onNonMatch: (nonMatch) {
      // ğŸ”“ åªè§£å¯†æ™®é€šæ–‡æœ¬
      buffer.write(
        nonMatch.runes.map((rune) {
          int newRune = rune - 10;
          if (newRune < 0) newRune += 0x110000;
          return String.fromCharCode(newRune);
        }).join(),
      );
      return '';
    },
  );
  return buffer.toString();
}
```

## ğŸ“Š å®Œæ•´æµç¨‹ç¤ºä¾‹

### åœºæ™¯1: çº¯è¡¨æƒ…æ¶ˆæ¯
```
å‘é€ï¼š[honkai3_pure_3]
â†“
åŠ å¯†å¤„ç†ï¼š
  âœ“ è¡¨æƒ…ç¬¦ä¸åŠ å¯†: [honkai3_pure_3]
  ç»“æœ: ï¿¿[honkai3_pure_3]
â†“
æœåŠ¡å™¨å­˜å‚¨ï¼šï¿¿[honkai3_pure_3]
â†“
æ¥æ”¶è§£å¯†ï¼š
  æ£€æµ‹åˆ°ï¿¿æ ‡è®°
  åŒ¹é… [honkai3_pure_3] â†’ ä¸è§£å¯†
  ç»“æœ: [honkai3_pure_3]
â†“
æ¸²æŸ“ï¼šæ˜¾ç¤ºä¸ºå´©å3è¡¨æƒ…å›¾ç‰‡ âœ…
```

### åœºæ™¯2: æ··åˆæ¶ˆæ¯
```
å‘é€ï¼šä½ å¥½[honkai3_pure_3]ä¸–ç•Œ
â†“
åŠ å¯†å¤„ç†ï¼š
  ğŸ”’ æ–‡æœ¬åŠ å¯†: "ä½ å¥½"
  âœ“ è¡¨æƒ…ç¬¦ä¸åŠ å¯†: [honkai3_pure_3]
  ğŸ”’ æ–‡æœ¬åŠ å¯†: "ä¸–ç•Œ"
  ç»“æœ: ï¿¿[åŠ å¯†]ä½ å¥½[honkai3_pure_3][åŠ å¯†]ä¸–ç•Œ
â†“
æœåŠ¡å™¨å­˜å‚¨ï¼šï¿¿[åŠ å¯†]ä½ å¥½[honkai3_pure_3][åŠ å¯†]ä¸–ç•Œ
â†“
æ¥æ”¶è§£å¯†ï¼š
  æ£€æµ‹åˆ°ï¿¿æ ‡è®°
  è§£å¯†æ–‡æœ¬éƒ¨åˆ†
  åŒ¹é… [honkai3_pure_3] â†’ ä¸è§£å¯†
  ç»“æœ: ä½ å¥½[honkai3_pure_3]ä¸–ç•Œ
â†“
æ¸²æŸ“ï¼š
  - "ä½ å¥½" æ˜¾ç¤ºä¸ºæ–‡æœ¬
  - [honkai3_pure_3] æ˜¾ç¤ºä¸ºè¡¨æƒ…å›¾ç‰‡
  - "ä¸–ç•Œ" æ˜¾ç¤ºä¸ºæ–‡æœ¬
  âœ…
```

### åœºæ™¯3: çº¯æ–‡æœ¬
```
å‘é€ï¼šä½ å¥½
â†“
åŠ å¯†å¤„ç†ï¼š
  ğŸ”’ æ–‡æœ¬åŠ å¯†: "ä½ å¥½"
  ç»“æœ: ï¿¿[åŠ å¯†]ä½ å¥½
â†“
æœåŠ¡å™¨å­˜å‚¨ï¼šï¿¿[åŠ å¯†]ä½ å¥½
â†“
æ¥æ”¶è§£å¯†ï¼š
  æ£€æµ‹åˆ°ï¿¿æ ‡è®°
  ğŸ”“ è§£å¯†æ–‡æœ¬: "ä½ å¥½"
  ç»“æœ: ä½ å¥½
â†“
æ¸²æŸ“ï¼šæ˜¾ç¤ºä¸º "ä½ å¥½" âœ…
```

## ğŸ”‘ å…³é”®ä¿®æ”¹ç‚¹

### 1. å‘é€ç«¯ (`controller.dart`)
- âœ… ä¿ç•™ `splitMapJoin` é€»è¾‘
- âœ… è¡¨æƒ…ç¬¦åŒ¹é…æ­£åˆ™ï¼š`r'\[.*?\]'`
- âœ… è¡¨æƒ…ç¬¦ä¸åŠ å¯†ï¼Œæ™®é€šæ–‡æœ¬åŠ å¯†
- âœ… æ·»åŠ  `\uFFFF` æ ‡è®°

### 2. æ¥æ”¶ç«¯ (`chat_item.dart`)
- âœ… æ·»åŠ è¡¨æƒ…ç¬¦ä¿æŠ¤æ­£åˆ™ï¼š`r'\[[\w_]+\]'`
- âœ… patterns åŒ…å«ï¼šURLæ­£åˆ™ + è¡¨æƒ…ç¬¦æ­£åˆ™ + eInfosä¸­çš„è¡¨æƒ…
- âœ… è§£å¯†æ—¶è·³è¿‡åŒ¹é…çš„è¡¨æƒ…ç¬¦
- âœ… æ¸²æŸ“æ—¶æŸ¥æ‰¾ emojiMapï¼Œæœ‰åˆ™æ˜¾ç¤ºå›¾ç‰‡ï¼Œæ— åˆ™æ˜¾ç¤ºæ–‡æœ¬

### 3. è¡¨æƒ…åŒ…é…ç½® (`custom_emote_service.dart`)
- âœ… `type = 4` (æ–‡æœ¬è¡¨æƒ…)
- âœ… è¡¨æƒ…ç¬¦æ ¼å¼ï¼š`[meme]` (ä¸­æ‹¬å·)

## ğŸ§ª æµ‹è¯•éªŒè¯

### æ§åˆ¶å°æ—¥å¿—

#### å‘é€æ—¶
```
ğŸ“¤ åŸå§‹æ¶ˆæ¯: ä½ å¥½[honkai3_pure_3]ä¸–ç•Œ
  ğŸ”’ æ–‡æœ¬åŠ å¯†: "ä½ å¥½" -> "[åŠ å¯†å]"
  âœ“ è¡¨æƒ…ç¬¦ä¸åŠ å¯†: [honkai3_pure_3]
  ğŸ”’ æ–‡æœ¬åŠ å¯†: "ä¸–ç•Œ" -> "[åŠ å¯†å]"
ğŸ“¤ åŠ å¯†åæ¶ˆæ¯: ï¿¿[åŠ å¯†]ä½ å¥½[honkai3_pure_3][åŠ å¯†]ä¸–ç•Œ
```

#### æ¥æ”¶æ—¶ï¼ˆéšå¼ï¼‰
- æ£€æµ‹ `\uFFFF` æ ‡è®°
- è§£å¯†æ™®é€šæ–‡æœ¬
- ä¿ç•™è¡¨æƒ…ç¬¦åŸæ ·
- ç»“æœï¼š`ä½ å¥½[honkai3_pure_3]ä¸–ç•Œ`

### è¿è¡Œæµ‹è¯•
```bash
flutter clean
flutter run --debug -d windows
```

1. è¿›å…¥ç§ä¿¡å¯¹è¯
2. ç‚¹å‡»è¡¨æƒ… â†’ å‘é€ `[honkai3_pure_3]`
3. è§‚å¯Ÿæ§åˆ¶å°è¾“å‡º
4. éªŒè¯æ¶ˆæ¯æ¸²æŸ“ä¸ºå›¾ç‰‡
5. åœ¨å®˜æ–¹å¹³å°æŸ¥çœ‹ï¼Œåº”è¯¥æ˜¾ç¤º `[honkai3_pure_3]`

## ğŸ“‹ ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ | çŠ¶æ€ |
|------|---------|------|
| `lib/pages/whisper_detail/controller.dart` | å‘é€ç«¯ï¼šsplitMapJoinéƒ¨åˆ†åŠ å¯† | âœ… |
| `lib/pages/whisper_detail/widget/chat_item.dart` | æ¥æ”¶ç«¯ï¼šæ·»åŠ è¡¨æƒ…ç¬¦ä¿æŠ¤æ­£åˆ™ | âœ… |
| `lib/services/custom_emote_service.dart` | type=4ï¼Œè¡¨æƒ…ç¬¦æ ¼å¼[meme] | âœ… |
| `lib/utils/image_utils.dart` | ä¿®å¤å¤–éƒ¨CDNå›¾ç‰‡åŠ è½½ | âœ… |
| `test.yaml` | è¡¨æƒ…ç¬¦æ ¼å¼æ”¹ä¸º[meme] | âœ… |

## ğŸ¯ é¢„æœŸç»“æœ

### PiliPluså®¢æˆ·ç«¯
- âœ… å‘é€ `[honkai3_pure_3]` â†’ æ˜¾ç¤ºä¸ºè¡¨æƒ…å›¾ç‰‡
- âœ… æ¥æ”¶ `[honkai3_pure_3]` â†’ æ˜¾ç¤ºä¸ºè¡¨æƒ…å›¾ç‰‡
- âœ… æ··åˆæ¶ˆæ¯æ­£ç¡®å¤„ç†

### å®˜æ–¹å¹³å°
- âœ… æ˜¾ç¤º `[honkai3_pure_3]` æ–‡æœ¬ï¼ˆå®˜æ–¹ä¸è¯†åˆ«è‡ªå®šä¹‰è¡¨æƒ…ï¼‰

### å…¼å®¹æ€§
- âœ… Bç«™å®˜æ–¹è¡¨æƒ…æ­£å¸¸å·¥ä½œ
- âœ… URLä¸è¢«ç ´å
- âœ… æ™®é€šæ–‡æœ¬æ­£å¸¸åŠ å¯†

## ğŸš€ å®Œæˆï¼

ç°åœ¨è‡ªå®šä¹‰è¡¨æƒ…åŒ…å°†å®Œå…¨ä¸å—åŠ å¯†/è§£å¯†å½±å“ï¼ŒåŒæ—¶ä¿æŒä¸Bç«™å®˜æ–¹è¡¨æƒ…åŒ…çš„å®Œç¾å…¼å®¹ï¼
